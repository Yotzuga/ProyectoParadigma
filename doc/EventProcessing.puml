@startuml EventProcessing
!theme plain

participant "Game::Run()" as GAME
participant "EventQueue" as Q
participant "Systems" as SYS
participant "World" as W

== FRAME: UPDATE PHASE ==

note over GAME, W
    Todos los sistemas ejecutan update()
    Emiten eventos en el queue
    pero NO se procesan
end note

GAME -> SYS: MovementSystem.update(dt)
SYS -> Q: EmitEvent(MovementEvent?)
note right of Q
    Eventos se encolan
    No procesado
end note

GAME -> SYS: CollisionSystem.update(dt)
SYS -> Q: EmitEvent(CollisionEvent)
note right of Q
    Otra evento encolada
end note

GAME -> SYS: DamageSystem.update(dt)
SYS -> Q: EmitEvent(HealthChangedEvent)
note right of Q
    Más eventos encolados
end note

note over GAME, Q
    UPDATE COMPLETADO
    Queue contiene:
    - CollisionEvent x 3
    - HealthChangedEvent x 2
    - SpawnWaveEvent x 1
end note

== FRAME: RENDER PHASE ==

GAME -> SYS: RenderSystem.update(dt)
note right of SYS
    Renderiza frames
    usando estado OLD
end note

GAME -> SYS: HUDSystem.update(dt)
note right of SYS
    Renderiza UI
end note

GAME -> SYS: WaveManagerSystem.render()
note right of SYS
    Renderiza fondos
end note

note right of GAME
    SDL_RenderPresent()
    Frame visible
end note

== CRITICAL: EVENT PROCESSING ==

GAME -> W: ProcessEvents()
note right of W
    ESTO ocurre DESPUÉS de render
    En WaveManagerSystem::render()
end note

W -> Q: GetNextEvent()
Q --> W: CollisionEvent

W -> SYS: HandleCollisionEvent()
note right of SYS
    CollisionResponseSystem
    procesa este evento
    Calcula separación
    Emite DamageEvent (nuevo)
end note

W -> Q: GetNextEvent()
Q --> W: HealthChangedEvent

W -> SYS: HandleHealthChangedEvent()
note right of SYS
    DamageSystem procesa
    Verifica if dead
    Si dead: EmitEvent(DeadEvent)
end note

W -> Q: GetNextEvent()
Q --> W: SpawnWaveEvent

W -> SYS: HandleSpawnWaveEvent()
note right of SYS
    SpawnSystem procesa
    Crea nuevas entidades
    Registra en HashMap
end note

W -> Q: GetNextEvent()
Q --> W: (empty)
note right of W
    Queue vacía
    ProcessEvents() completa
end note

== FRAME N+1 ==

note over GAME, W
    Próximo frame inicia
    Nuevo update() con estado actualizado
    de eventos procesados
end note

@enduml
