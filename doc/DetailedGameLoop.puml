@startuml DetailedGameLoop
!theme plain

participant "Game::Render()" as RENDER
participant "PlayerInputSystem" as INPUT
participant "MovementSystem" as MOVE
participant "EnemyAISystem" as AI
participant "CollisionSystem" as COLL
participant "DamageSystem" as DMG
participant "RenderSystem" as RSYS
participant "SDL3" as SDL

== FRAME N (16.67ms @ 60FPS) ==

RENDER -> RENDER: deltaTime = (now - lastFrame) / 1000
note right of RENDER
    Frame-rate independent
    Típicamente 0.0167 segundos
end note

== INPUT PHASE ==
RENDER -> INPUT: Update(World, dt)
note right of INPUT
    Lee SDL_GetKeyboardState()
    Calcula vx, vy del Player
end note

== UPDATE PHASE ==
RENDER -> MOVE: Update(World, dt)
note right of MOVE
    Para cada entidad con Transform:
    x += vx * dt
    y += vy * dt
end note

RENDER -> AI: Update(World, dt)
note right of AI
    Para cada enemigo:
    Persigue al Player
    Usa Lerp para suavidad
end note

== PHYSICS PHASE ==
RENDER -> COLL: Update(World, dt)
note right of COLL
    Detecta colisiones AABB
    Genera lista de pares que colisionan
    Complejidad: O(n²) sin optimización
end note

note over RENDER, COLL
    Fórmula AABB:
    A.x < B.x + B.width AND
    A.x + A.width > B.x AND
    A.y < B.y + B.height AND
    A.y + A.height > B.y
end note

RENDER -> RENDER: CollisionResponseSystem.Update(World, dt)
note right of RENDER
    Resuelve overlaps
    Separa cuerpos que colisionen
    Aplica push a entidades
end note

RENDER -> DMG: Update(World, dt)
note right of DMG
    Procesa colisiones de daño
    Reduce Health
    Si health <= 0: marca como muerto
    Si Player muerto: m_GameOver = true
end note

note over RENDER, DMG
    FRAME ACTUALIZADO
    Todas las posiciones correctas
    Daño procesado
end note

== RENDER PHASE ==
RENDER -> SDL: SDL_SetRenderDrawColor(0, 0, 0, 255)
RENDER -> SDL: SDL_RenderClear()
note right of SDL
    Clear buffer a negro
end note

RENDER -> RSYS: Update(World, dt)
note right of RSYS
    Para cada entidad con Sprite + Transform:
    SDL_RenderTexture(texture, srcRect, destRect)
    Renderiza todas las entidades
end note

RENDER -> RENDER: HUDSystem.Update(World, dt)
note right of RENDER
    Renderiza UI: HP, Oleada, Tiempo
    Usa spdlog para debug
end note

RENDER -> RENDER: MusicSystem.Update()
note right of RENDER
    Si m_GameOver: Stop()
    Detiene la música una sola vez
end note

RENDER -> SDL: SDL_RenderPresent()
note right of SDL
    Intercambia front/back buffer
    Frame visible en monitor
    ~16.67ms después del anterior
end note

note over RENDER, SDL
    ✓ Frame completado
    ✓ Todo renderizado
    ✓ Listo para siguiente frame
end note
    RENDER COMPLETADO
    Pantalla actualizada
    Eventos procesados
end note

== NEXT FRAME ==
note right of RUN
    Bucle continúa
    Nuevo deltaTime calculado
end note

@enduml
