@startuml PlayerInvulnerability
!theme plain

participant "DamageSystem" as DMG
participant "World" as W
participant "PlayerComponent" as PC
participant "RenderSystem" as REN
participant "Entity" as PLAYER

== DAÑO RECIBIDO ==

DMG -> W: ProcessDamageEvent()
note right of W
    event.entity = Player
    event.damage = 10
end note

DMG -> PC: GetComponent<Player>()
DMG -> PC: TakeDamage(10)
note right of PC
    m_CurrentHealth -= 10
    
    IF m_CurrentHealth > 0:
        m_Invulnerable = true
        m_InvulnerabilityTimer = 2.0 (segundos)
        m_FlashInterval = 0.1 (segundos)
end note

== INVULNERABILITY DURATION ==

loop While m_InvulnerabilityTimer > 0

    DMG -> PC: update(dt)
    PC -> PC: m_InvulnerabilityTimer -= dt
    
    alt m_InvulnerabilityTimer <= 0
        note right of PC
            Invulnerabilidad acabada
        end
        PC -> PC: m_Invulnerable = false
        
    else Timer activo
        
        PC -> PC: m_FlashCounter += dt
        
        alt m_FlashCounter >= m_FlashInterval
            
            note right of PC
                Cambiar visibilidad
            end
            
            PC -> PC: m_FlashCounter = 0
            PC -> PC: m_IsVisible = !m_IsVisible
            
            note right of PC
                Si era visible → invisible
                Si era invisible → visible
                
                Crea efecto parpadeo
            end
            
        end
        
    end

end

== RENDER WITH FLASHING ==

loop While invulnerable

    REN -> PLAYER: GetComponent<Sprite>()
    note right of REN
        Obtener sprite_idx
    end note

    PC -> PC: if (m_IsVisible)
    note right of PC
        m_IsVisible = true/false
        alternativamente cada 0.1s
    end note

    alt m_IsVisible == true
        
        REN -> REN: SDL_RenderTexture()
        note right of REN
            Renderiza sprite en pantalla
        end note

    else m_IsVisible == false
        
        note right of REN
            NO renderiza
            Space en pantalla (vacío)
        end note

    end

end

== EFECTO VISUAL ==

note right of REN
    @ 2.0 segundos de invulnerabilidad
    con 0.1s flash interval:
    
    20 ciclos totales de parpadeo
    
    On  (0.1s)  → Se ve sprite
    Off (0.1s)  → Vacío
    On  (0.1s)  → Se ve sprite
    Off (0.1s)  → Vacío
    ...
    
    Resultado: Parpadeo visible
    indicando invulnerabilidad
end note

== DESPUÉS DE INVULNERABILIDAD ==

PC -> PC: m_IsVisible = true
PC -> PC: m_Invulnerable = false
note right of PC
    Vuelve a estar visible
    Si recibe daño nuevamente:
    Está VULNERABLE
    (no invulnerable)
end note

@enduml
